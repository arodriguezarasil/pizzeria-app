<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bienvenido</title>
<!-- Firebase (compat) para login con Google -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
<style>
  body{ margin:0; font-family:Montserrat,Arial; background:#2b2b2b; color:#fff; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px; }
  .card{ width:min(520px,100%); background:#faf7f2; color:#222; border-radius:18px; box-shadow:0 18px 45px rgba(0,0,0,.35); overflow:hidden; position:relative; }
  .card::before{ content:""; position:absolute; top:0; left:0; height:12px; width:100%; background:linear-gradient(to right,#1e7f43 0%,#1e7f43 33.33%,#fff 33.33%,#fff 66.66%,#8c1d18 66.66%,#8c1d18 100%); }
  .inner{ padding:22px; }
  h1{ margin:10px 0 6px; font-family:"Playfair Display",serif; color:#8c1d18; letter-spacing:1px; }
  .muted{ color:#666; font-size:13px; margin:0 0 16px; }
  .btn{ width:100%; border:1px solid #ddd; background:#fff; padding:12px 14px; border-radius:12px; font-weight:900; cursor:pointer; margin-top:10px; transition: opacity 0.2s ease, transform 0.1s ease; }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{ background:#8c1d18; border-color:#8c1d18; color:#fff; }
  .btn.google{ opacity:.6; cursor:not-allowed; }
  .btn.google.enabled{ opacity:1; cursor:pointer; background:#fff; border-color:#4285f4; color:#333; }
</style>
</head>
<body>
  <div class="card">
    <div class="inner">
      <h1>IL FORNO DI ALESSANDRO</h1>
      <p class="muted">Elige una opci√≥n para continuar.</p>

      <button class="btn primary" onclick="location.href='/login.html'">Iniciar sesi√≥n</button>
      <button id="btnGoogle" class="btn google" disabled>üîí Iniciar sesi√≥n con Google</button>
      <button class="btn" onclick="location.href='/register.html'">Registrarse</button>
    </div>
  </div>

<script>
  const btnGoogle = document.getElementById("btnGoogle");

  // ========= Firebase / Google Login =========
  function initFirebase(){
    // Esperar a que Firebase est√© disponible
    if (typeof firebase === 'undefined') {
      console.warn("Firebase SDK a√∫n no est√° cargado, reintentando...");
      setTimeout(initFirebase, 100);
      return;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDAfFywakwJfbMq9TesUXjd1x3WEGHia-Y",
      authDomain: "ilfornodialessandro.firebaseapp.com",
      projectId: "ilfornodialessandro",
      storageBucket: "ilfornodialessandro.firebasestorage.app",
      messagingSenderId: "292923743751",
      appId: "1:292923743751:web:7837ce91edb2e4665d94a2",
      measurementId: "G-HCGRKDY2FZ"
    };

    try{
      // Verificar si ya est√° inicializado
      if (firebase.apps && firebase.apps.length > 0) {
        console.log("Firebase ya est√° inicializado");
      } else {
        firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase inicializado correctamente");
      }
      
      btnGoogle.disabled = false;
      btnGoogle.classList.add("enabled");
      btnGoogle.textContent = "üîê Iniciar sesi√≥n con Google";
      console.log("‚úÖ Bot√≥n de Google habilitado");
    } catch(e){
      console.error("‚ùå Error inicializando Firebase:", e);
      btnGoogle.textContent = "‚ùå Error cargando Google";
    }
  }

  async function doGoogleLogin(){
    try{
      const auth = firebase.auth();
      const provider = new firebase.auth.GoogleAuthProvider();

      btnGoogle.disabled = true;
      btnGoogle.textContent = "Conectando con Google...";

      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      if (!user){
        alert("No se pudo completar el login con Google.");
        return;
      }

      const idToken = await user.getIdToken();

      const r = await fetch("/api/login/google", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({ idToken })
      });
      const d = await r.json().catch(()=>({}));

      if (!r.ok){
        alert(d.error || "Error iniciando sesi√≥n con Google.");
        return;
      }

      window.location.replace("/index.html");
    } catch(e){
      console.error("Google login error:", e);
      alert("No se pudo completar el login con Google.");
    } finally {
      btnGoogle.disabled = false;
      btnGoogle.textContent = "üîê Iniciar sesi√≥n con Google";
    }
  }

  btnGoogle.addEventListener("click", () => {
    if (btnGoogle.disabled) return;
    doGoogleLogin();
  });

  // Inicializar Firebase cuando la p√°gina est√© completamente cargada
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFirebase);
  } else {
    setTimeout(initFirebase, 100);
  }
</script>
</body>
</html>
