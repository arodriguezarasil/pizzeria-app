<!-- ===== public/login.html ===== -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Iniciar sesi√≥n</title>
<!-- Firebase (compat) para login con Google -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Montserrat:wght@400;500;800;900&display=swap" rel="stylesheet">

<style>
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:'Montserrat', Arial, sans-serif;
    background:#2b2b2b;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    color:#222;
  }

  .card{
    width:min(520px, 100%);
    background:#faf7f2;
    border-radius:18px;
    box-shadow:0 18px 45px rgba(0,0,0,.35);
    overflow:hidden;
    position:relative;
  }

  .card::before{
    content:"";
    position:absolute;
    top:0; left:0;
    width:100%; height:12px;
    background: linear-gradient(
      to right,
      #1e7f43 0%,
      #1e7f43 33.33%,
      #ffffff 33.33%,
      #ffffff 66.66%,
      #8c1d18 66.66%,
      #8c1d18 100%
    );
  }

  .head{
    padding:18px 18px 10px;
    background:#fff;
    border-bottom:1px solid #eee;
    text-align:center;
  }

  h1{
    margin:10px 0 0;
    font-family:'Playfair Display', serif;
    color:#8c1d18;
    font-size:26px;
    letter-spacing:1px;
  }
  .sub{
    margin:6px 0 0;
    color:#666;
    font-size:12px;
    font-weight:600;
  }

  .body{ padding:18px; }

  .row{ margin-top:12px; }

  .field{
    background:#fff;
    border:1px solid #e6e2dc;
    border-radius:14px;
    padding:12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);
  }
  .field input{
    width:100%;
    border:0;
    outline:0;
    font-size:14px;
    background:transparent;
    padding:4px 2px;
  }

  .muted{
    color:#777;
    font-size:12px;
    margin-top:10px;
    line-height:1.4;
    text-align:center;
  }

  .actions{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:14px;
  }

  .btn{
    width:100%;
    border:1px solid #ddd;
    background:#fff;
    padding:12px 14px;
    border-radius:14px;
    font-weight:900;
    cursor:pointer;
    transition: transform .12s ease, opacity .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); opacity:.98; }

  .btn.primary{
    background:#8c1d18;
    border-color:#8c1d18;
    color:#fff;
  }

  .btn.google{
    background:#fff;
    border-color:#ddd;
    color:#333;
    font-weight:900;
    opacity:.55;
    cursor:not-allowed;
  }
  .btn.google.enabled{
    opacity:1;
    cursor:pointer;
  }

  .btn.link{
    background:transparent;
    border-color:transparent;
    color:#1e7f43;
    font-weight:900;
    padding:10px 14px;
  }
  .btn.link:hover{
    transform:none;
    opacity:1;
    text-decoration:underline;
  }

  /* ‚úÖ Nuevo: link ‚Äúolvid√© contrase√±a‚Äù m√°s discreto */
  .btn.forgot{
    margin-top:-2px;
    color:#8c1d18;
  }

  .msg{
    margin-top:12px;
    font-size:13px;
    font-weight:800;
    text-align:center;
  }
  .msg.ok{ color:#1e7f43; }
  .msg.err{ color:#8c1d18; }
</style>
</head>

<body>
  <div class="card">
    <div class="head">
      <h1>Iniciar sesi√≥n</h1>
      <div class="sub">Accede a la carta y haz tu pedido.</div>
    </div>

    <div class="body">
      <div class="row">
        <div class="field">
          <input id="user" autocomplete="username" placeholder="Usuario o correo">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <input id="pass" type="password" autocomplete="current-password" placeholder="Contrase√±a">
        </div>
      </div>

      <div class="actions">
        <button id="btnLogin" class="btn primary">Entrar</button>

        <!-- ‚úÖ Nuevo: olvid√© contrase√±a -->
        <button id="btnForgot" class="btn link forgot">¬øHas olvidado la contrase√±a?</button>

        <button id="btnGoogle" class="btn google" disabled>üîí Iniciar sesi√≥n con Google</button>
        <button id="btnGoRegister" class="btn link">No tengo cuenta ‚Üí Registrarme</button>
        <button id="btnBackWelcome" class="btn link">Volver</button>
      </div>

      <div id="msg" class="msg" style="display:none;"></div>

      <div class="muted">
        Si tu cuenta no est√° aprobada, no podr√°s entrar hasta que el admin la acepte.
      </div>
    </div>
  </div>

<script>
  async function forceLogoutToWelcome(){
    try { await fetch("/api/logout", { method:"POST", credentials:"include" }); } catch {}
    window.location.replace("/welcome.html");
  }

  // Evita ‚Äúvolver atr√°s‚Äù a pantallas no deseadas
  window.addEventListener("popstate", forceLogoutToWelcome);
  window.addEventListener("pageshow", (e) => { if (e.persisted) forceLogoutToWelcome(); });
  history.pushState({login:true}, "", location.href);

  const $ = (id) => document.getElementById(id);
  const msg = $("msg");
  const btnGoogle = $("btnGoogle");

  function showMsg(text, ok){
    msg.style.display = "block";
    msg.textContent = text;
    msg.className = "msg " + (ok ? "ok" : "err");
  }

  // ========= Firebase / Google Login =========
  function initFirebase(){
    // Esperar a que Firebase est√© disponible
    if (typeof firebase === 'undefined') {
      console.warn("Firebase SDK a√∫n no est√° cargado, reintentando...");
      setTimeout(initFirebase, 100);
      return;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDAfFywakwJfbMq9TesUXjd1x3WEGHia-Y",
      authDomain: "ilfornodialessandro.firebaseapp.com",
      projectId: "ilfornodialessandro",
      storageBucket: "ilfornodialessandro.firebasestorage.app",
      messagingSenderId: "292923743751",
      appId: "1:292923743751:web:7837ce91edb2e4665d94a2",
      measurementId: "G-HCGRKDY2FZ"
    };

    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("PON_AQUI")) {
      console.warn("Firebase no est√° configurado todav√≠a. Edita public/login.html con tu firebaseConfig.");
      return;
    }

    try{
      // Verificar si ya est√° inicializado
      if (firebase.apps && firebase.apps.length > 0) {
        console.log("Firebase ya est√° inicializado");
      } else {
        firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase inicializado correctamente");
      }
      
      btnGoogle.disabled = false;
      btnGoogle.classList.add("enabled");
      btnGoogle.textContent = "üîê Iniciar sesi√≥n con Google";
      console.log("‚úÖ Bot√≥n de Google habilitado");
    } catch(e){
      console.error("‚ùå Error inicializando Firebase:", e);
      btnGoogle.textContent = "‚ùå Error cargando Google";
    }
  }

  async function doGoogleLogin(){
    try{
      const auth = firebase.auth();
      const provider = new firebase.auth.GoogleAuthProvider();

      btnGoogle.disabled = true;
      btnGoogle.textContent = "Conectando con Google...";

      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      if (!user){
        showMsg("No se pudo completar el login con Google.", false);
        return;
      }

      const idToken = await user.getIdToken();

      const r = await fetch("/api/login/google", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({ idToken })
      });
      const d = await r.json().catch(()=>({}));

      if (!r.ok){
        showMsg(d.error || "Error iniciando sesi√≥n con Google.", false);
        return;
      }

      window.location.replace("/index.html");
    } catch(e){
      console.error("Google login error:", e);
      showMsg("No se pudo completar el login con Google.", false);
    } finally {
      btnGoogle.disabled = false;
      btnGoogle.textContent = "Iniciar sesi√≥n con Google";
    }
  }

  async function doLogin(){
    const usernameOrEmail = $("user").value.trim();
    const password = $("pass").value;

    if (!usernameOrEmail || !password){
      showMsg("Rellena usuario/correo y contrase√±a.", false);
      return;
    }

    const btn = $("btnLogin");
    btn.disabled = true;
    btn.textContent = "Entrando...";

    try{
      const r = await fetch("/api/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({ usernameOrEmail, password })
      });

      const d = await r.json().catch(()=>({}));

      if (!r.ok){
        showMsg(d.error || "Error iniciando sesi√≥n.", false);
        return;
      }

      // OK -> carta
      window.location.replace("/index.html");
    } catch (e){
      showMsg("No se pudo conectar con el servidor.", false);
    } finally {
      btn.disabled = false;
      btn.textContent = "Entrar";
    }
  }

  $("btnLogin").addEventListener("click", doLogin);
  $("_attachEnter")?.remove?.(); // por si existiera algo viejo (no pasa nada si no existe)
  $("pass").addEventListener("keydown", (e)=>{ if (e.key === "Enter") doLogin(); });

  $("btnForgot").addEventListener("click", ()=> window.location.href="/forgot-password.html");
  $("btnGoRegister").addEventListener("click", ()=> window.location.href="/register.html");
  $("btnBackWelcome").addEventListener("click", ()=> window.location.href="/welcome.html");
  btnGoogle.addEventListener("click", () => {
    if (btnGoogle.disabled) return;
    doGoogleLogin();
  });

  // Si ya est√° logueado, fuera de aqu√≠
  (async()=>{
    try{
      const r = await fetch("/api/me", { credentials:"include" });
      const d = await r.json();
      if (d.loggedIn) window.location.replace("/index.html");
    } catch {}
  })();

  // Inicializar Firebase cuando la p√°gina est√© completamente cargada
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFirebase);
  } else {
    // Si ya est√° cargado, esperar un poco a que Firebase SDK est√© disponible
    setTimeout(initFirebase, 100);
  }
</script>
</body>
</html>
