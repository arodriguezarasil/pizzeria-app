<!-- ===== public/register.html ===== -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Montserrat:wght@400;500;800;900&display=swap" rel="stylesheet">

<style>
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:'Montserrat', Arial, sans-serif;
    background:#2b2b2b;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    color:#222;
  }

  .card{
    width:min(560px, 100%);
    background:#faf7f2;
    border-radius:18px;
    box-shadow:0 18px 45px rgba(0,0,0,.35);
    overflow:hidden;
    position:relative;
  }

  .card::before{
    content:"";
    position:absolute;
    top:0; left:0;
    width:100%; height:12px;
    background: linear-gradient(
      to right,
      #1e7f43 0%,
      #1e7f43 33.33%,
      #ffffff 33.33%,
      #ffffff 66.66%,
      #8c1d18 66.66%,
      #8c1d18 100%
    );
  }

  .head{
    padding:18px 18px 10px;
    background:#fff;
    border-bottom:1px solid #eee;
    text-align:center;
  }

  h1{
    margin:10px 0 0;
    font-family:'Playfair Display', serif;
    color:#8c1d18;
    font-size:26px;
    letter-spacing:1px;
  }
  .sub{
    margin:6px 0 0;
    color:#666;
    font-size:12px;
    font-weight:600;
  }

  .body{ padding:18px; }

  .row{ margin-top:12px; }

  .field{
    background:#fff;
    border:1px solid #e6e2dc;
    border-radius:14px;
    padding:12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);
  }
  .field input{
    width:100%;
    border:0;
    outline:0;
    font-size:14px;
    background:transparent;
    padding:4px 2px;
  }

  .muted{
    color:#777;
    font-size:12px;
    margin-top:10px;
    line-height:1.4;
    text-align:center;
  }

  .actions{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:14px;
  }

  .btn{
    width:100%;
    border:1px solid #ddd;
    background:#fff;
    padding:12px 14px;
    border-radius:14px;
    font-weight:900;
    cursor:pointer;
    transition: transform .12s ease, opacity .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); opacity:.98; }

  .btn.primary{
    background:#1e7f43;
    border-color:#1e7f43;
    color:#fff;
  }
  .btn.primary:disabled{
    opacity:.55;
    cursor:not-allowed;
    transform:none;
  }

  .btn.link{
    background:transparent;
    border-color:transparent;
    color:#8c1d18;
    font-weight:900;
    padding:10px 14px;
  }
  .btn.link:hover{
    transform:none;
    opacity:1;
    text-decoration:underline;
  }

  .msg{
    margin-top:12px;
    font-size:13px;
    font-weight:800;
    text-align:center;
  }
  .msg.ok{ color:#1e7f43; }
  .msg.err{ color:#8c1d18; }
</style>
</head>

<body>
  <div class="card">
    <div class="head">
      <h1>Registro</h1>
      <div class="sub">Envía tu solicitud al admin para que la apruebe.</div>
    </div>

    <div class="body">
      <div class="row">
        <div class="field">
          <input id="username" autocomplete="username" placeholder="Nombre de usuario">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <input id="email" type="email" autocomplete="email" placeholder="Correo">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <input id="password" type="password" autocomplete="new-password" placeholder="Contraseña (mín. 6)">
        </div>
      </div>

      <div class="actions">
        <button id="btnRegister" class="btn primary">Enviar solicitud</button>
        <button id="btnGoLogin" class="btn link">Ya tengo cuenta → Iniciar sesión</button>
        <button id="btnBackWelcome" class="btn link">Volver</button>
      </div>

      <div id="msg" class="msg" style="display:none;"></div>

      <div class="muted">
        Si ya enviaste una solicitud, espera a que el admin la apruebe.
      </div>
    </div>
  </div>

<script>
  async function forceLogoutToWelcome(){
    try { await fetch("/api/logout", { method:"POST", credentials:"include" }); } catch {}
    window.location.replace("/welcome.html");
  }

  // Evita “volver atrás” a pantallas no deseadas
  window.addEventListener("popstate", forceLogoutToWelcome);
  window.addEventListener("pageshow", (e) => { if (e.persisted) forceLogoutToWelcome(); });
  history.pushState({register:true}, "", location.href);

  const $ = (id) => document.getElementById(id);
  const msg = $("msg");
  const btn = $("btnRegister");

  function showMsg(text, ok){
    msg.style.display = "block";
    msg.textContent = text;
    msg.className = "msg " + (ok ? "ok" : "err");
  }

  function disableRegister(text){
    btn.disabled = true;
    btn.textContent = text || "Solicitud ya enviada";
  }

  async function doRegister(){
    const username = $("username").value.trim();
    const email = $("email").value.trim();
    const password = $("password").value;

    if (!username || !email || !password){
      showMsg("Rellena usuario, correo y contraseña.", false);
      return;
    }

    btn.disabled = true;
    btn.textContent = "Enviando...";

    try{
      const r = await fetch("/api/register", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({ username, email, password })
      });

      const d = await r.json().catch(()=>({}));

      if (!r.ok){
        const err = (d.error || "Error enviando solicitud.");

        // Si el backend devuelve el típico mensaje de “ya enviaste…”
        if (String(err).toLowerCase().includes("ya enviaste")){
          showMsg(err, false);
          disableRegister("Solicitud ya enviada ✅");
          return;
        }

        showMsg(err, false);
        return;
      }

      showMsg(d.message || "Solicitud enviada. Espera aprobación.", true);
      disableRegister("Solicitud enviada ✅");
    } catch (e){
      showMsg("No se pudo conectar con el servidor.", false);
      btn.disabled = false;
      btn.textContent = "Enviar solicitud";
    }
  }

  btn.addEventListener("click", doRegister);
  $("password").addEventListener("keydown", (e)=>{ if (e.key === "Enter") doRegister(); });

  $("btnGoLogin").addEventListener("click", ()=> window.location.href="/login.html");
  $("btnBackWelcome").addEventListener("click", ()=> window.location.href="/welcome.html");

  // Si ya está logueado, fuera
  (async()=>{
    try{
      const r = await fetch("/api/me", { credentials:"include" });
      const d = await r.json();
      if (d.loggedIn) window.location.replace("/index.html");
    } catch {}
  })();
</script>
</body>
</html>
